<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦¾ç¦¾ç§Ÿè»Šç®¡ç†ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --success: #34a853;
            --danger: #ea4335;
            --bg: #f0f2f5; /* è¼•å¾®æ·±ä¸€é»çš„ç°è‰²èƒŒæ™¯ï¼Œè®“å¡ç‰‡æ›´çªå‡º */
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            padding: 12px; 
            margin: 0; 
            display: flex;
            flex-direction: column;
            align-items: center; /* è®“å…§å®¹å±…ä¸­ */
        }
        /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé˜²æ­¢åœ¨å¤§è¢å¹•ä¸Šè®Šå¤ªé†œ */
        .container {
            width: 100%;
            max-width: 450px;
        }
        h2 { text-align: center; color: #202124; margin: 20px 0; font-size: 1.4rem; }
        
        .card { 
            background: white; 
            padding: 16px; 
            border-radius: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            margin-bottom: 16px; 
        }
        .card-title { font-size: 0.95rem; font-weight: 700; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; }
        
        /* 4 æ ¼è³‡è¨Šå„ªåŒ– */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-box { background: #f8f9fa; padding: 12px; border-radius: 12px; border: 1px solid #edf2f7; }
        .info-box label { display: block; font-size: 0.7rem; color: #718096; margin-bottom: 4px; }
        .info-box div { font-size: 0.95rem; font-weight: 800; color: #2d3748; }
        .date-highlight { color: var(--danger) !important; }

        /* æ¸…å–®æ¨£å¼ */
        .item { 
            padding: 14px 0; 
            border-bottom: 1px solid #f1f3f4; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .item:last-child { border-bottom: none; }
        .item-detail b { font-size: 1rem; color: #1a202c; }
        .item-detail small { color: #718096; }
        
        .status-badge { 
            padding: 5px 12px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: 700; 
        }
        .paid { background: #e6f4ea; color: var(--success); }
        .unpaid { background: #fce8e6; color: var(--danger); }

        /* è¡¨å–®èˆ‡æŒ‰éˆ• */
        input, select { width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 1rem; box-sizing: border-box; }
        button { cursor: pointer; border: none; width: 100%; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 1rem; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; margin-top: 10px; }
        .btn-main:active { opacity: 0.8; }
        .hidden { display: none; }
        
        #loader { margin-top: 40vh; text-align: center; color: #718096; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loader">ğŸ›¡ï¸ æ­£åœ¨è®€å–ç²¾ç·»ä»‹é¢...</div>

        <div id="app" class="hidden">
            <h2 id="user-name">ä½ å¥½</h2>
            
            <div class="card">
                <div class="card-title">ğŸš˜ è»Šè¼›èˆ‡åˆç´„è³‡è¨Š</div>
                <div id="user-profile" class="info-grid"></div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ’° å¸³å‹™æ˜ç´°</div>
                <div id="list"></div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“¸ ä¸Šå‚³ç¹³è²»æ”¶æ“š</div>
                <input type="file" id="receipt-file" accept="image/*">
                <button onclick="uploadReceipt()" class="btn-main" style="background:#f6ad55;">ç¢ºèªé€å‡ºç…§ç‰‡</button>
            </div>
            
            <button onclick="showAdmin()" style="background:none; color:#a0aec0; font-size:0.8rem; margin-top:10px;">ç®¡ç†å“¡ç™»å…¥</button>
        </div>

        <div id="admin-view" class="card hidden">
            <h3 style="color:var(--primary); margin-top:0;">æ–°å¢å¸³å‹™</h3>
            <input list="driver-list" id="new-name" oninput="autoFill()" placeholder="æœå°‹å¸æ©Ÿå§“å">
            <datalist id="driver-list"></datalist>
            <input type="text" id="new-userId" placeholder="UserID">
            <div style="display:flex; gap:10px;"><input type="date" id="new-date"><input type="text" id="new-carNo" placeholder="è»Šè™Ÿ"></div>
            <div style="display:flex; gap:10px;">
                <select id="new-carType"><option value="æ²¹é›»CC">æ²¹é›»CC</option><option value="é˜¿æ³•">é˜¿æ³•</option></select>
                <select id="new-carStatus"><option value="ç§Ÿè»Š">ç§Ÿè»Š</option><option value="é è¡Œ">é è¡Œ</option></select>
            </div>
            <div style="padding:10px 0;">
                <label style="font-size:0.8rem; font-weight:bold;"><input type="checkbox" id="check-rent"> è»Šç§Ÿ</label>
                <input type="number" id="amt-rent" placeholder="é‡‘é¡">
            </div>
            <select id="pay-status"><option value="false">æœªç¹³</option><option value="true">å·²ç¹³</option></select>
            <button onclick="submit()" class="btn-main" style="background:var(--success);">å„²å­˜å¸³å‹™</button>
            <button onclick="location.reload()" style="background:none; color:#718096; margin-top:10px;">å–æ¶ˆ</button>
        </div>

        <div id="admin-login" class="card hidden">
            <input type="password" id="admin-pwd" placeholder="å¯†ç¢¼">
            <button onclick="checkAdmin()" class="btn-main">ç™»å…¥</button>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008825791-99Vl1KKs"; 
        const API_URL = "https://script.google.com/macros/s/AKfycbzLdEr-LHoejFMpThHvzXSs7ARu_RkFPWIVcMPWtRo4zNBW6OVFRUR2iwnsd2Pat-QS/exec"; 

        let driverData = []; 
        let currentUserId = "";

        async function start() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); } 
                else {
                    const profile = await liff.getProfile();
                    currentUserId = profile.userId;
                    const res = await fetch(API_URL);
                    driverData = await res.json();
                    document.getElementById('driver-list').innerHTML = [...new Set(driverData.map(d => d.å§“å))].map(n => `<option value="${n}">`).join('');
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('user-name').innerText = "ä½ å¥½ï¼Œ" + profile.displayName;
                    renderUI(driverData, currentUserId);
                }
            } catch (err) { alert("é€£ç·šå¤±æ•—"); }
        }

        // âœ¨ æ ¼å¼æ¸…æ´—å™¨
        function cleanDate(d) {
            if (!d) return 'ç„¡';
            return d.toString().split('T')[0].replace(/-/g, '/');
        }

        function renderUI(data, uid) {
            const myData = data.filter(r => String(r.å¸³è™Ÿ).trim() === uid.trim());
            const profileDiv = document.getElementById('user-profile');
            if (myData.length > 0) {
                const last = myData.filter(r => r.ä¸‹æ¬¡ç¹³è²»æ—¥æœŸ).pop() || myData[myData.length-1];
                // æ¢å¾© 4 æ ¼è¦–è¦ºåŒ–ï¼ŒåŠ ä¸Šæ¸…æ´—å¾Œçš„æ—¥æœŸ
                profileDiv.innerHTML = `
                    <div class="info-box"><label>è»Šè™Ÿ</label><div>${last.è»Šè™Ÿ || '-'}</div></div>
                    <div class="info-box"><label>è»Šå‹</label><div>${last.è»Šå‹ || '-'}</div></div>
                    <div class="info-box"><label>åˆç´„ç‹€æ…‹</label><div>${last.ç‹€æ…‹ || '-'}</div></div>
                    <div class="info-box"><label>ä¸‹æ¬¡ç¹³è²»</label><div class="date-highlight">${cleanDate(last.ä¸‹æ¬¡ç¹³è²»æ—¥æœŸ)}</div></div>
                `;
                document.getElementById('list').innerHTML = myData.map(r => `
                    <div class="item">
                        <div class="item-detail"><b>${r.æ”¶è²»é …ç›®}</b><br><small>NT$ ${r.é‡‘é¡}</small></div>
                        <div class="status-badge ${ (r.ç¹³è²»ç‹€æ…‹===true||r.ç¹³è²»ç‹€æ…‹==="TRUE"||r.ç¹³è²»ç‹€æ…‹==="å·²ç¹³")?'paid':'unpaid'}">${ (r.ç¹³è²»ç‹€æ…‹===true||r.ç¹³è²»ç‹€æ…‹==="TRUE"||r.ç¹³è²»ç‹€æ…‹==="å·²ç¹³")?'âœ… å·²ç¹³':'âš ï¸ æœªç¹³'}</div>
                    </div>
                `).join('');
            }
        }
        
        function autoFill() {
            const name = document.getElementById('new-name').value;
            const m = driverData.filter(d => String(d.å§“å).trim() === name.trim());
            if (m.length > 0) {
                const last = m[m.length - 1];
                document.getElementById('new-userId').value = m.find(d => String(d.å¸³è™Ÿ).startsWith('U'))?.å¸³è™Ÿ || "å¾…è£œ ID";
                document.getElementById('new-carNo').value = last.è»Šè™Ÿ || "";
                document.getElementById('new-carType').value = last.è»Šå‹ || "";
                document.getElementById('new-carStatus').value = last.ç‹€æ…‹ || "ç§Ÿè»Š";
            }
        }

        async function submit() {
            const items = [];
            if(document.getElementById('check-rent').checked) items.push({ name: 'è»Šç§Ÿ', amount: document.getElementById('amt-rent').value });
            const payload = {
                type: "adminAdd", userIdInput: document.getElementById('new-userId').value,
                name: document.getElementById('new-name').value, joinDate: document.getElementById('new-date').value.replace(/-/g, '/'),
                carNo: document.getElementById('new-carNo').value, carType: document.getElementById('new-carType').value,
                carStatus: document.getElementById('new-carStatus').value, items: items, payStatus: document.getElementById('pay-status').value === "true"
            };
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert("å·²å„²å­˜"); location.reload();
        }
        function showAdmin() { document.getElementById('app').classList.add('hidden'); document.getElementById('admin-login').classList.remove('hidden'); }
        function checkAdmin() { if(document.getElementById('admin-pwd').value === "admin123") { document.getElementById('admin-login').classList.add('hidden'); document.getElementById('admin-view').classList.remove('hidden'); } }
        async function uploadReceipt() {
            const fileInput = document.getElementById('receipt-file');
            if (fileInput.files.length === 0) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const payload = { type: "uploadReceipt", userId: currentUserId, base64: e.target.result.split(',')[1], mimeType: fileInput.files[0].type };
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("ä¸Šå‚³æˆåŠŸ"); location.reload();
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
        start();
    </script>
</body>
</html>
