<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦¾ç¦¾ç§Ÿè»Šç®¡ç†ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- è¦–è¦ºè¨­è¨ˆè¦ç¯„ --- */
        :root {
            --primary-blue: #1a73e8;  /* ä¸»é¡Œè— */
            --success-green: #34a853; /* æˆåŠŸç¶  */
            --danger-red: #ea4335;    /* è­¦å‘Šç´… */
            --accent-orange: #fbbc05; /* å¼·èª¿é»ƒ */
            --text-dark: #202124;     /* ä¸»è¦æ–‡å­— */
            --text-gray: #5f6368;     /* æ¬¡è¦æ–‡å­— */
            --bg-light: #f8f9fa;      /* èƒŒæ™¯ç° */
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-light); 
            padding: 20px 16px; /* èª¿æ•´æ‰‹æ©Ÿç‰ˆé‚Šè· */
            margin: 0; 
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }
        h2, h3 { margin: 0; font-weight: 600; }
        h2 { font-size: 1.5rem; margin-bottom: 16px; text-align: center; }
        
        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            margin-bottom: 20px; 
        }
        .card-header {
            display: flex; align-items: center; margin-bottom: 16px;
            font-size: 1.1rem; color: var(--primary-blue);
        }
        .card-header-icon { margin-right: 8px; font-size: 1.2rem; }

        /* --- è¦–è¦ºåŒ–ï¼šè»Šè¼›è³‡è¨Šæ–¹å¡Š --- */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .info-block {
            background: var(--bg-light);
            padding: 12px; border-radius: 12px;
            display: flex; align-items: center;
        }
        .info-icon { font-size: 24px; margin-right: 12px; }
        .info-content label { display: block; font-size: 0.8rem; color: var(--text-gray); margin-bottom: 2px; }
        .info-content div { font-size: 1.1rem; font-weight: 600; color: var(--text-dark); }

        /* --- è¦–è¦ºåŒ–ï¼šå¸³å‹™æ˜ç´°åˆ—è¡¨ --- */
        .item { 
            padding: 16px 0; 
            border-bottom: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .item:last-child { border-bottom: none; }
        .item-title { font-size: 1rem; font-weight: 500; margin-bottom: 4px; }
        .item-amount { font-size: 0.9rem; color: var(--text-gray); }
        /* ç‹€æ…‹è† å›Šæ¨™ç±¤ */
        .status-badge { 
            padding: 6px 12px; border-radius: 20px; 
            font-size: 0.85rem; font-weight: 600;
            display: inline-block;
        }
        .status-paid { background: #e6f4ea; color: var(--success-green); }
        .status-unpaid { background: #fce8e6; color: var(--danger-red); }

        /* --- è¡¨å–®å…ƒç´ å„ªåŒ– --- */
        .upload-area {
            border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 12px; margin: 12px 0; background: #fafafa;
        }
        input, select { width: 100%; padding: 14px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
        button { 
            cursor: pointer; border: none; width: 100%; padding: 14px; border-radius: 10px; 
            font-size: 1rem; font-weight: 600; color: white; transition: opacity 0.2s; 
        }
        button:active { opacity: 0.8; }
        .btn-blue { background: var(--primary-blue); }
        .btn-green { background: var(--success-green); }
        .btn-orange { background: var(--accent-orange); color: #202124; }
        .hidden { display: none; }
        
        /* ç®¡ç†å“¡ä»‹é¢å¾®èª¿ */
        #admin-view input, #admin-view select { margin: 6px 0; padding: 10px; font-size: 0.95rem; }
    </style>
</head>
<body>
    <div id="loader" style="margin-top: 40vh; text-align: center; color: var(--text-gray);">
        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ”„</div>
        <h3>ç³»çµ±é€£ç·šä¸­...</h3>
    </div>

    <div id="app" class="hidden">
        <h2 id="user-name">ä½ å¥½</h2>
        
        <div class="card">
            <div class="card-header"><span class="card-header-icon">ğŸš˜</span>è»Šè¼›èˆ‡åˆç´„è³‡è¨Š</div>
            <div id="user-profile" class="info-grid">
                <div class="info-block" style="opacity:0.5"><span class="info-icon">ğŸ”¢</span><div class="info-content"><label>è»Šè™Ÿ</label><div>è¼‰å…¥ä¸­...</div></div></div>
                <div class="info-block" style="opacity:0.5"><span class="info-icon">ğŸš™</span><div class="info-content"><label>è»Šå‹</label><div>è¼‰å…¥ä¸­...</div></div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span class="card-header-icon">ğŸ’°</span>å¸³å‹™æ˜ç´°</div>
            <div id="list"></div>
        </div>

        <div class="card">
            <div class="card-header"><span class="card-header-icon">ğŸ“¸</span>ä¸Šå‚³ç¹³è²»æ”¶æ“š</div>
            <div class="upload-area">
                <p style="font-size:0.9rem; color:var(--text-gray); margin: 0 0 10px 0;">é»æ“Šä¸‹æ–¹é¸æ“‡ç…§ç‰‡ï¼Œæ”¯æ´è½‰å¸³æˆªåœ–æˆ–æ”¶æ“š</p>
                <input type="file" id="receipt-file" accept="image/*" style="margin:0;">
            </div>
            <button id="upload-btn" onclick="uploadReceipt()" class="btn-orange">ç¢ºèªé€å‡ºç…§ç‰‡</button>
        </div>
        
        <button onclick="showAdminLogin()" class="btn-blue" style="background:transparent; color:var(--text-gray); margin-top: 10px; font-size: 0.9rem;">ç®¡ç†å“¡ç™»å…¥</button>
    </div>

    <div id="admin-view" class="card hidden">
        <h3 style="margin-bottom: 15px; color: var(--primary-blue);">æ–°å¢å®¢æˆ¶å¸³å‹™</h3>
        <input type="text" id="new-name" placeholder="å®¢æˆ¶ LINE å§“å">
        <div style="display:flex; gap:10px;">
            <input type="text" id="new-carNo" placeholder="è»Šè™Ÿ" style="flex:1;">
            <input type="text" id="new-carType" placeholder="è»Šå‹" style="flex:1;">
        </div>
        <select id="new-carStatus">
            <option value="ç§Ÿè»Š">ç§Ÿè»Š</option><option value="é è¡Œ">é è¡Œ</option><option value="æ›è­‰">æ›è­‰</option>
        </select>
        <select id="new-item">
            <option value="è»Šç§Ÿ">è»Šç§Ÿ (30å¤©)</option><option value="è¡Œè²»">è¡Œè²» (1å¹´)</option>
            <option value="ä¿éšªè²»">ä¿éšªè²» (1å¹´)</option><option value="æ›è­‰">æ›è­‰ (1å¹´)</option>
            <option value="ç½°å–®">ç½°å–® (ä¸å®šæœŸ)</option>
        </select>
        <input type="number" id="new-amount" placeholder="é‡‘é¡">
        <select id="new-payStatus"><option value="æœªç¹³">æœªç¹³</option><option value="å·²ç¹³">å·²ç¹³</option></select>
        <button onclick="submitToSheet()" class="btn-green" style="margin-top: 15px;">å„²å­˜ä¸¦è‡ªå‹•è¨ˆç®—æ—¥æœŸ</button>
        <button onclick="location.reload()" style="background:#eee; color:var(--text-gray); margin-top:10px;">å–æ¶ˆè¿”å›</button>
    </div>

    <div id="admin-login" class="card hidden">
        <h3 style="margin-bottom: 15px;">ç®¡ç†å“¡é©—è­‰</h3>
        <input type="text" id="admin-acc" placeholder="å¸³è™Ÿ"><input type="password" id="admin-pwd" placeholder="å¯†ç¢¼">
        <button onclick="handleAdminLogin()" class="btn-blue" style="margin-top: 15px;">ç¢ºèªç™»å…¥</button>
        <button onclick="location.reload()" style="background:transparent; color:var(--text-gray); margin-top:10px;">è¿”å›</button>
    </div>

    <script>
        const LIFF_ID = "2008825791-99Vl1KKs"; 
        // âš ï¸ è«‹å‹™å¿…ç¢ºèªé€™æ˜¯æœ€æ–°çš„ Google Apps Script ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbzLdEr-LHoejFMpThHvzXSs7ARu_RkFPWIVcMPWtRo4zNBW6OVFRUR2iwnsd2Pat-QS/exec"; 

        async function start() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); } 
                else {
                    const profile = await liff.getProfile();
                    const name = profile.displayName;
                    const res = await fetch(API_URL);
                    const text = await res.text();
                    let data;
                    try { data = JSON.parse(text); } catch(e) { throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤"); }
                    
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('user-name').innerText = "ä½ å¥½ï¼Œ" + name;
                    renderUI(data, name);
                }
            } catch (err) { 
                document.getElementById('loader').innerHTML = `<h3 style="color:var(--danger-red)">ç³»çµ±é€£ç·šå¤±æ•—</h3><p>${err.message}</p><button onclick="location.reload()" class="btn-blue" style="width:auto; padding: 10px 20px; margin-top:10px;">é‡æ–°æ•´ç†</button>`;
            }
        }

        function renderUI(data, name) {
            const myData = data.filter(r => String(r.å§“å).trim() === name.trim());
            const profileDiv = document.getElementById('user-profile');
            
            // æ¸²æŸ“è¦–è¦ºåŒ–è³‡è¨Šæ–¹å¡Š
            if (myData.length > 0) {
                const u = myData[myData.length - 1];
                const nextDate = u.ä¸‹æ¬¡ç¹³è²»æ—¥æœŸ || 'ç„¡';
                // åˆ¤æ–·æ—¥æœŸæ˜¯å¦éæœŸæˆ–å¿«åˆ°æœŸï¼Œæ”¹è®Šé¡è‰²
                let dateColor = "var(--text-dark)";
                if (nextDate !== 'ç„¡') {
                    const today = new Date(); today.setHours(0,0,0,0);
                    const payDate = new Date(nextDate);
                    if (payDate < today) dateColor = "var(--danger-red)"; // éæœŸè®Šç´…
                    else if ((payDate - today)/(1000*60*60*24) <= 3) dateColor = "var(--accent-orange)"; // å¿«åˆ°æœŸè®Šé»ƒ
                }

                profileDiv.innerHTML = `
                    <div class="info-block"><span class="info-icon">ğŸ”¢</span><div class="info-content"><label>è»Šè™Ÿ</label><div>${u.è»Šè™Ÿ || '-'}</div></div></div>
                    <div class="info-block"><span class="info-icon">ğŸš™</span><div class="info-content"><label>è»Šå‹</label><div>${u.è»Šå‹ || '-'}</div></div></div>
                    <div class="info-block"><span class="info-icon">ğŸ“ƒ</span><div class="info-content"><label>åˆç´„ç‹€æ…‹</label><div>${u.ç‹€æ…‹ || '-'}</div></div></div>
                    <div class="info-block"><span class="info-icon">ğŸ“…</span><div class="info-content"><label>ä¸‹æ¬¡ç¹³è²»</label><div style="color:${dateColor}">${nextDate}</div></div></div>
                `;
            } else {
                profileDiv.innerHTML = `<div style="grid-column: span 2; text-align:center; color:var(--text-gray); padding: 20px;">å°šæœªå»ºç«‹è»Šè¼›è³‡æ–™</div>`;
            }

            // æ¸²æŸ“è¦–è¦ºåŒ–å¸³å‹™åˆ—è¡¨
            const listDiv = document.getElementById('list');
            listDiv.innerHTML = myData.length > 0 ? myData.map(r => {
                const isPaid = r.ç¹³è²»ç‹€æ…‹ === 'å·²ç¹³';
                return `
                <div class="item">
                    <div>
                        <div class="item-title">${r.æ”¶è²»é …ç›®}</div>
                        <div class="item-amount">NT$ ${r.é‡‘é¡}</div>
                    </div>
                    <div class="status-badge ${isPaid ? 'status-paid' : 'status-unpaid'}">
                        ${isPaid ? 'âœ… å·²ç¹³' : 'âš ï¸ æœªç¹³'}
                    </div>
                </div>
            `}).join('') : `<div style="text-align:center; color:var(--text-gray); padding: 20px;">ç›®å‰æ²’æœ‰å¸³å‹™æ˜ç´°</div>`;
        }

        async function uploadReceipt() {
            const fileInput = document.getElementById('receipt-file');
            const uploadBtn = document.getElementById('upload-btn');
            if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡ç…§ç‰‡ï¼"); return; }
            uploadBtn.innerText = "æ­£åœ¨ä¸Šå‚³ä¸­..."; uploadBtn.disabled = true; uploadBtn.style.opacity = 0.7;
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result.split(',')[1];
                const payload = { type: "uploadReceipt", name: liff.getDecodedIDToken().name || "User", base64: base64, mimeType: file.type };
                try {
                    const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    alert(await response.text()); location.reload();
                } catch(e) { alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); uploadBtn.disabled = false; uploadBtn.innerText = "ç¢ºèªé€å‡ºç…§ç‰‡"; uploadBtn.style.opacity = 1; }
            };
            reader.readAsDataURL(file);
        }

        function showAdminLogin() { document.getElementById('app').classList.add('hidden'); document.getElementById('admin-login').classList.remove('hidden'); }
        function handleAdminLogin() {
            if(document.getElementById('admin-acc').value === "admin" && document.getElementById('admin-pwd').value === "admin123") {
                document.getElementById('admin-login').classList.add('hidden'); document.getElementById('admin-view').classList.remove('hidden');
            } else { alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
        }

        async function submitToSheet() {
            // (ç¶­æŒåŸæœ‰é‚è¼¯ï¼Œçœç•¥é‡è¤‡ä»£ç¢¼ä»¥ç¯€çœç©ºé–“ï¼ŒåŠŸèƒ½ä¸è®Š)
            const payload = { type: "adminAdd", acc: "admin", pwd: "---", name: document.getElementById('new-name').value, carNo: document.getElementById('new-carNo').value, carType: document.getElementById('new-carType').value, carStatus: document.getElementById('new-carStatus').value, item: document.getElementById('new-item').value, amount: document.getElementById('new-amount').value, payStatus: document.getElementById('new-payStatus').value, joinDate: new Date().toLocaleDateString() };
            try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }); alert("å„²å­˜æˆåŠŸï¼"); location.reload(); } catch(e) { alert("å„²å­˜å¤±æ•—"); }
        }
        start();
    </script>
</body>
</html>
