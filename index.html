<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>禾禾租車管理系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --danger: #ea4335; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-box { background: var(--bg); padding: 10px; border-radius: 10px; }
        .info-box label { display: block; font-size: 0.75rem; color: #666; }
        .info-box div { font-weight: bold; }
        .item { padding: 12px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .paid { background: #e6f4ea; color: var(--success); }
        .unpaid { background: #fce8e6; color: var(--danger); }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .multi-select { text-align: left; margin: 10px 0; }
        .multi-item { display: flex; align-items: center; gap: 10px; background: #f0f0f0; padding: 8px; margin-bottom: 5px; border-radius: 8px; }
        .multi-item input[type="checkbox"] { width: auto; margin: 0; }
        .multi-item input[type="number"] { width: 80px; padding: 5px; margin: 0; }
        button { cursor: pointer; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; }
        .btn-main { background: var(--primary); color: white; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="loader" style="margin-top: 45vh; text-align: center;"><h3>系統載入中...</h3></div>

    <div id="app" class="hidden">
        <h2 id="user-name" style="text-align:center;">你好</h2>
        <div class="card">
            <div id="user-profile" class="info-grid"></div>
        </div>
        <div class="card">
            <div id="list"></div>
        </div>
        <div class="card">
            <input type="file" id="receipt-file" accept="image/*">
            <button id="upload-btn" onclick="uploadReceipt()" class="btn-main" style="background:#f39c12;">送出收據照片</button>
        </div>
        <button onclick="showAdminLogin()" style="background:none; color:#666; margin-top:20px;">管理員登入</button>
    </div>

    <div id="admin-view" class="card hidden">
        <h3>新增多項帳務</h3>
        <input type="text" id="new-userId" placeholder="司機 UserID">
        <input type="text" id="new-name" placeholder="司機姓名">
        <div style="display:flex; gap:5px;"><input type="text" id="new-carNo" placeholder="車號"><input type="text" id="new-carType" placeholder="車型"></div>
        
        <div class="multi-select">
            <label style="font-size:0.8rem; font-weight:bold;">請勾選收費項目與金額：</label>
            <div class="multi-item"><input type="checkbox" value="車租"> 車租 <input type="number" class="item-amt" placeholder="金額"></div>
            <div class="multi-item"><input type="checkbox" value="行費"> 行費 <input type="number" class="item-amt" placeholder="金額"></div>
            <div class="multi-item"><input type="checkbox" value="保險費"> 保險費 <input type="number" class="item-amt" placeholder="金額"></div>
            <div class="multi-item"><input type="checkbox" value="換證"> 換證 <input type="number" class="item-amt" placeholder="金額"></div>
            <div class="multi-item"><input type="checkbox" value="罰單"> 罰單 <input type="number" class="item-amt" placeholder="金額"></div>
        </div>

        <select id="new-status"><option value="false">未繳 (方塊不勾)</option><option value="true">已繳 (方塊勾選)</option></select>
        <button onclick="submitToSheet()" class="btn-main" style="background:var(--success);">一次儲存所有勾選項目</button>
        <button onclick="location.reload()" style="background:none; color:#666; margin-top:10px;">取消</button>
    </div>

    <div id="admin-login" class="card hidden">
        <h3>管理員登入</h3>
        <input type="text" id="admin-acc" placeholder="帳號"><input type="password" id="admin-pwd" placeholder="密碼">
        <button onclick="handleAdminLogin()" class="btn-main">登入</button>
    </div>

    <script>
        const LIFF_ID = "2008825791-99Vl1KKs"; 
        const API_URL = "https://script.google.com/macros/s/AKfycbzLdEr-LHoejFMpThHvzXSs7ARu_RkFPWIVcMPWtRo4zNBW6OVFRUR2iwnsd2Pat-QS/exec"; 
        let currentUserId = "";

        async function start() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); } 
                else {
                    const profile = await liff.getProfile();
                    currentUserId = profile.userId;
                    const res = await fetch(API_URL);
                    const data = await res.json();
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('user-name').innerText = "你好，" + profile.displayName;
                    renderUI(data, currentUserId);
                }
            } catch (err) { alert("連線失敗"); }
        }

        function renderUI(data, userId) {
            const myData = data.filter(r => String(r.帳號).trim() === userId.trim());
            const profileDiv = document.getElementById('user-profile');
            if (myData.length > 0) {
                // 抓最新一筆有日期的資料顯示
                const dateData = myData.filter(r => r.下次繳費日期).pop() || myData[myData.length-1];
                profileDiv.innerHTML = `
                    <div class="info-box"><label>車號</label><div>${dateData.車號 || '-'}</div></div>
                    <div class="info-box"><label>下次繳費</label><div style="color:red;">${dateData.下次繳費日期 || '無'}</div></div>
                `;
                document.getElementById('list').innerHTML = myData.map(r => `
                    <div class="item">
                        <div><b>${r.收費項目}</b><br><small>NT$ ${r.金額}</small></div>
                        <div class="status-badge ${ (r.繳費狀態===true||r.繳費狀態==="TRUE")?'paid':'unpaid'}">${ (r.繳費狀態===true||r.繳費狀態==="TRUE")?'✅ 已繳':'⚠️ 未繳'}</div>
                    </div>
                `).join('');
            } else {
                profileDiv.innerHTML = `<div style="grid-column: span 2; text-align:center;">未綁定 ID：<br><small>${userId}</small></div>`;
            }
        }

        async function submitToSheet() {
            const checkedItems = [];
            document.querySelectorAll('.multi-item').forEach(div => {
                const cb = div.querySelector('input[type="checkbox"]');
                const amt = div.querySelector('.item-amt').value;
                if (cb.checked) { checkedItems.push({ name: cb.value, amount: amt }); }
            });

            if (checkedItems.length === 0) { alert("請至少勾選一個項目"); return; }

            const payload = {
                type: "adminAdd", userIdInput: document.getElementById('new-userId').value,
                name: document.getElementById('new-name').value, carNo: document.getElementById('new-carNo').value,
                carType: document.getElementById('new-carType').value, carStatus: "靠行",
                items: checkedItems, payStatus: document.getElementById('new-status').value === "true",
                joinDate: new Date().toLocaleDateString()
            };
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert("成功新增 " + checkedItems.length + " 筆資料"); location.reload();
        }

        function showAdminLogin() { document.getElementById('app').classList.add('hidden'); document.getElementById('admin-login').classList.remove('hidden'); }
        function handleAdminLogin() {
            if(document.getElementById('admin-acc').value === "admin" && document.getElementById('admin-pwd').value === "admin123") {
                document.getElementById('admin-login').classList.add('hidden'); document.getElementById('admin-view').classList.remove('hidden');
            } else { alert("錯誤"); }
        }
        async function uploadReceipt() {
            const fileInput = document.getElementById('receipt-file');
            if (fileInput.files.length === 0) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const payload = { type: "uploadReceipt", userId: currentUserId, base64: e.target.result.split(',')[1], mimeType: fileInput.files[0].type };
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert(await res.text()); location.reload();
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
        start();
    </script>
</body>
</html>
