<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦¾ç¦¾ç§Ÿè»Šç®¡ç†ç³»çµ± V17</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --danger: #ea4335; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; margin: 0; color: #202124; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .card-title { color: var(--primary); font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .info-box { background: var(--bg); padding: 12px; border-radius: 12px; display: flex; align-items: center; }
        .info-icon { font-size: 24px; margin-right: 12px; }
        .info-content label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 2px; }
        .info-content div { font-size: 0.95rem; font-weight: 700; }
        .item { padding: 15px 0; border-bottom: 1px solid #f1f3f4; display: flex; justify-content: space-between; align-items: center; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
        .paid { background: #e6f4ea; color: var(--success); }
        .unpaid { background: #fce8e6; color: var(--danger); }
        input, select { width: 100%; padding: 12px; margin: 6px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; }
        .multi-area { margin: 15px 0; border: 1px solid #eee; border-radius: 10px; padding: 10px; }
        .multi-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; border-bottom: 1px solid #f9f9f9; padding-bottom: 8px; }
        .multi-row input[type="checkbox"] { width: 22px; height: 22px; margin: 0; }
        .multi-row input[type="number"] { flex: 1; padding: 8px; font-size: 0.9rem; }
        button { cursor: pointer; border: none; width: 100%; padding: 14px; border-radius: 10px; font-weight: bold; font-size: 1rem; }
        .btn-main { background: var(--primary); color: white; margin-top: 15px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="loader" style="margin-top: 45vh; text-align: center; color: #666;"><h3>ğŸ›¡ï¸ æ­£åœ¨è®€å–è»Šè¼›è³‡æ–™...</h3></div>

    <div id="app" class="hidden">
        <h2 id="user-name" style="text-align:center; margin-bottom: 20px;">ä½ å¥½</h2>
        
        <div class="card">
            <div class="card-title">ğŸš˜ è»Šè¼›èˆ‡åˆç´„è³‡è¨Š</div>
            <div id="user-profile" class="info-grid"></div>
        </div>

        <div class="card"><div id="list"></div></div>

        <div class="card">
            <div class="card-title">ğŸ“¸ ä¸Šå‚³æ”¶æ“šç…§ç‰‡</div>
            <input type="file" id="receipt-file" accept="image/*">
            <button id="upload-btn" onclick="uploadReceipt()" class="btn-main" style="background:#f39c12;">ç¢ºèªé€å‡ºæ”¶æ“š</button>
        </div>
        <button onclick="showAdminLogin()" style="background:none; color:#666; font-size:0.8rem; margin-top:20px;">ç®¡ç†å“¡å°ˆå€</button>
    </div>

    <div id="admin-view" class="card hidden">
        <h3 style="color:var(--primary); margin-top:0;">æ–°å¢å¸³å‹™ (æ™ºæ…§é€£å‹•ç‰ˆ)</h3>
        
        <label style="font-size:0.8rem; font-weight:bold;">å¸æ©Ÿå§“åï¼š</label>
        <input list="driver-list" id="new-name" oninput="autoFillData()" placeholder="è¼¸å…¥åå­—è‡ªå‹•æœå°‹">
        <datalist id="driver-list"></datalist>

        <label style="font-size:0.8rem; color:#666;">UserIDï¼š</label>
        <input type="text" id="new-userId" placeholder="UserID å°‡è‡ªå‹•å°ä½">

        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label style="font-size:0.75rem;">åŠ å…¥æ—¥æœŸ</label><input type="date" id="new-joinDate"></div>
            <div style="flex:1;"><label style="font-size:0.75rem;">è»Šè™Ÿ</label><input type="text" id="new-carNo"></div>
        </div>

        <div style="display:flex; gap:10px; margin-top:5px;">
            <div style="flex:1;">
                <label style="font-size:0.75rem;">è»Šå‹</label>
                <select id="new-carType">
                    <option value="">--é¸æ“‡--</option>
                    <option value="æ²¹é›»CC">æ²¹é›»CC</option><option value="é˜¿æ³•">é˜¿æ³•</option><option value="å°Šæ¦®é»‘">å°Šæ¦®é»‘</option>
                </select>
            </div>
            <div style="flex:1;">
                <label style="font-size:0.75rem;">åˆç´„ç‹€æ…‹</label>
                <select id="new-carStatus">
                    <option value="ç§Ÿè»Š">ç§Ÿè»Š</option><option value="é è¡Œ">é è¡Œ</option><option value="æ›è­‰">æ›è­‰</option>
                </select>
            </div>
        </div>
        
        <div class="multi-area">
            <label style="font-size:0.85rem; font-weight:bold;">é¸æ“‡æ”¶è²»é …ç›®ï¼š</label>
            <div class="multi-row"><input type="checkbox" value="è»Šç§Ÿ"> è»Šç§Ÿ <input type="number" class="item-amt" placeholder="é‡‘é¡"></div>
            <div class="multi-row"><input type="checkbox" value="è¡Œè²»"> è¡Œè²» <input type="number" class="item-amt" placeholder="é‡‘é¡"></div>
            <div class="multi-row"><input type="checkbox" value="ä¿éšªè²»"> ä¿éšªè²» <input type="number" class="item-amt" placeholder="é‡‘é¡"></div>
            <div class="multi-row"><input type="checkbox" value="æ›è­‰"> æ›è­‰ <input type="number" class="item-amt" placeholder="é‡‘é¡"></div>
            <div class="multi-row"><input type="checkbox" value="ç½°å–®"> ç½°å–® <input type="number" class="item-amt" placeholder="é‡‘é¡"></div>
        </div>

        <select id="new-status"><option value="false">ç¹³è²»ç‹€æ…‹ï¼šæœªç¹³</option><option value="true">ç¹³è²»ç‹€æ…‹ï¼šå·²ç¹³</option></select>
        <button onclick="submitToSheet()" class="btn-main" style="background:var(--success);">ç¢ºèªå„²å­˜</button>
        <button onclick="location.reload()" style="background:#eee; color:#666; margin-top:10px;">å–æ¶ˆè¿”å›</button>
    </div>

    <div id="admin-login" class="card hidden">
        <h3>ç®¡ç†å“¡é©—è­‰</h3>
        <input type="text" id="admin-acc" placeholder="å¸³è™Ÿ"><input type="password" id="admin-pwd" placeholder="å¯†ç¢¼">
        <button onclick="handleAdminLogin()" class="btn-main">ç¢ºèªç™»å…¥</button>
    </div>

    <script>
        const LIFF_ID = "2008825791-99Vl1KKs"; 
        const API_URL = "https://script.google.com/macros/s/AKfycbzLdEr-LHoejFMpThHvzXSs7ARu_RkFPWIVcMPWtRo4zNBW6OVFRUR2iwnsd2Pat-QS/exec"; 
        let currentUserId = "";
        let driverData = []; 

        async function start() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); } 
                else {
                    const profile = await liff.getProfile();
                    currentUserId = profile.userId;
                    const res = await fetch(API_URL);
                    // ä¿®æ­£ï¼šå¢åŠ éŒ¯èª¤æ””æˆªä»¥è™•ç† SyntaxError
                    const text = await res.text();
                    try { driverData = JSON.parse(text); } catch(e) { throw new Error("GAS ç¶²å€å›æ‡‰éŒ¯èª¤ï¼Œè«‹é‡æ–°éƒ¨ç½²ä¸¦æ›´æ–° URL"); }
                    
                    const listHtml = [...new Set(driverData.map(d => String(d.å§“å).trim()))]
                        .map(name => `<option value="${name}">`).join('');
                    document.getElementById('driver-list').innerHTML = listHtml;
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('user-name').innerText = "ä½ å¥½ï¼Œ" + profile.displayName;
                    renderUI(driverData, currentUserId);
                }
            } catch (err) { alert("ç³»çµ±éŒ¯èª¤ï¼š" + err.message); }
        }

        // âœ¨ å¼·åŒ–é€£å‹•é‚è¼¯ï¼šå„ªå…ˆæ‰¾ã€ŒçœŸ IDã€+ è£œå›è»Šå‹å°æ‡‰
        function autoFillData() {
            const nameInput = document.getElementById('new-name').value;
            const matches = driverData.filter(d => String(d.å§“å).trim() === nameInput.trim());
            if (matches.length > 0) {
                const realIdRecord = matches.find(d => String(d.å¸³è™Ÿ).startsWith('U'));
                const lastRecord = matches[matches.length - 1];

                document.getElementById('new-userId').value = realIdRecord ? realIdRecord.å¸³è™Ÿ : (lastRecord.å¸³è™Ÿ || "å¾…è£œ ID");
                document.getElementById('new-carNo').value = lastRecord.è»Šè™Ÿ || "";
                
                if (lastRecord.åŠ å…¥æ—¥æœŸ) {
                    const d = lastRecord.åŠ å…¥æ—¥æœŸ.split('/');
                    if (d.length === 3) document.getElementById('new-joinDate').value = `${d[0]}-${d[1].padStart(2,'0')}-${d[2].padStart(2,'0')}`;
                }
                
                // ç¢ºä¿æ‰‹æ©Ÿç«¯çš„æ¨™ç±¤èˆ‡è©¦ç®—è¡¨å°é½Š
                if (lastRecord.è»Šå‹) document.getElementById('new-carType').value = lastRecord.è»Šå‹;
                if (lastRecord.åˆç´„ç‹€æ…‹) document.getElementById('new-carStatus').value = lastRecord.åˆç´„ç‹€æ…‹;
            }
        }

        function renderUI(data, userId) {
            const myData = data.filter(r => String(r.å¸³è™Ÿ).trim() === userId.trim());
            const profileDiv = document.getElementById('user-profile');
            if (myData.length > 0) {
                const dateEntry = myData.filter(r => r.ä¸‹æ¬¡ç¹³è²»æ—¥æœŸ).pop() || myData[myData.length-1];
                profileDiv.innerHTML = `
                    <div class="info-box"><span class="info-icon">ğŸ”¢</span><div class="info-content"><label>è»Šè™Ÿ</label><div>${dateEntry.è»Šè™Ÿ || '-'}</div></div></div>
                    <div class="info-box"><span class="info-icon">ğŸš™</span><div class="info-content"><label>è»Šå‹</label><div>${dateEntry.è»Šå‹ || '-'}</div></div></div>
                    <div class="info-box"><span class="info-icon">ğŸ“ƒ</span><div class="info-content"><label>åˆç´„ç‹€æ…‹</label><div>${dateEntry.åˆç´„ç‹€æ…‹ || '-'}</div></div></div>
                    <div class="info-box"><span class="info-icon">ğŸ“…</span><div class="info-content"><label>ä¸‹æ¬¡ç¹³è²»</label><div style="color:red;">${dateEntry.ä¸‹æ¬¡ç¹³è²»æ—¥æœŸ || 'ç„¡'}</div></div></div>
                `;
                document.getElementById('list').innerHTML = myData.map(r => `
                    <div class="item">
                        <div><b>${r.æ”¶è²»é …ç›®}</b><br><small>NT$ ${r.é‡‘é¡}</small></div>
                        <div class="status-badge ${ (r.ç¹³è²»ç‹€æ…‹===true||r.ç¹³è²»ç‹€æ…‹==="TRUE"||r.ç¹³è²»ç‹€æ…‹==="å·²ç¹³")?'paid':'unpaid'}">${ (r.ç¹³è²»ç‹€æ…‹===true||r.ç¹³è²»ç‹€æ…‹==="TRUE"||r.ç¹³è²»ç‹€æ…‹==="å·²ç¹³")?'âœ… å·²ç¹³':'âš ï¸ æœªç¹³'}</div>
                    </div>
                `).join('');
            } else {
                profileDiv.innerHTML = `<div style="grid-column: span 2; text-align:center; padding: 20px;">âš ï¸ å°šæœªç¶å®šæ¬Šé™<br><small>IDï¼š${userId}</small></div>`;
            }
        }

        async function submitToSheet() {
            const checkedItems = [];
            document.querySelectorAll('.multi-row').forEach(row => {
                const cb = row.querySelector('input[type="checkbox"]');
                const amt = row.querySelector('.item-amt').value;
                if (cb.checked) { checkedItems.push({ name: cb.value, amount: amt }); }
            });
            if (checkedItems.length === 0) { alert("è«‹å‹¾é¸æ”¶è²»é …ç›®"); return; }
            const payload = {
                type: "adminAdd", userIdInput: document.getElementById('new-userId').value,
                name: document.getElementById('new-name').value, joinDate: document.getElementById('new-joinDate').value.replace(/-/g, '/'),
                carNo: document.getElementById('new-carNo').value, carType: document.getElementById('new-carType').value,
                carStatus: document.getElementById('new-carStatus').value, items: checkedItems, payStatus: document.getElementById('new-status').value === "true"
            };
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert(await res.text()); location.reload();
        }

        function showAdminLogin() { document.getElementById('app').classList.add('hidden'); document.getElementById('admin-login').classList.remove('hidden'); }
        function handleAdminLogin() {
            if(document.getElementById('admin-acc').value === "admin" && document.getElementById('admin-pwd').value === "admin123") {
                document.getElementById('admin-login').classList.add('hidden'); document.getElementById('admin-view').classList.remove('hidden');
            } else { alert("éŒ¯èª¤"); }
        }
        async function uploadReceipt() {
            const fileInput = document.getElementById('receipt-file');
            if (fileInput.files.length === 0) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const payload = { type: "uploadReceipt", userId: currentUserId, base64: e.target.result.split(',')[1], mimeType: fileInput.files[0].type };
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert(await res.text()); location.reload();
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
        start();
    </script>
</body>
</html>
